package edu.hp.model.biz;

import edu.hp.model.biz.common.ConfRmModule;
import edu.hp.model.common.Constants;
import edu.hp.model.vo.ClsRmBtchRsvtnViewImpl;
import edu.hp.model.vo.ClsRmCalDMLViewImpl;
import edu.hp.model.vo.ConfRoomBatchReservationViewImpl;
import edu.hp.model.vo.ConfRoomCalendarViewImpl;
import edu.hp.model.vo.LovsViewImpl;
import edu.hp.model.vo.query.classrm.ClassroomCalendarConflitQueryImpl;
import edu.hp.model.vo.query.conf.ConfRmConflictViewImpl;
import edu.hp.model.vo.query.conf.ConfRoomQueryViewImpl;

import java.math.BigDecimal;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;

import oracle.jbo.Row;
import oracle.jbo.ViewCriteria;
import oracle.jbo.domain.Timestamp;
import oracle.jbo.server.ApplicationModuleImpl;
import oracle.jbo.server.ViewLinkImpl;
import oracle.jbo.server.ViewObjectImpl;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Sun Jun 02 11:11:30 CST 2013
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class ConfRmModuleImpl extends ApplicationModuleImpl implements ConfRmModule {
    /**
     * This is the default constructor (do not remove).
     */
    public ConfRmModuleImpl() {
    }
    /**
     * 返回值表示该批量预订是否在创建相关预订时发现有冲突，true为有冲突，反之为无冲突
     * @return
     */
    public boolean saveBatchOrders() {

        boolean hasconflict = false;

        ConfRoomBatchReservationViewImpl btchRsvtnView = this.getConfRoomBatch();
        /* Validate Current Batch Input */
        Row currentRow = btchRsvtnView.getCurrentRow();
        currentRow.validate();


        /* Remove all classroom activity associated with this batch  */
        deleteRelatedClassroomActivities(currentRow);

        /*Create new Classroom Activities */
        boolean[] occurs = new boolean[14];
        occurs[0] = ((String)currentRow.getAttribute("FstWkSun")).equals("Y") ? true : false;
        occurs[1] = ((String)currentRow.getAttribute("FstWkMon")).equals("Y") ? true : false;
        occurs[2] = ((String)currentRow.getAttribute("FstWkTue")).equals("Y") ? true : false;
        occurs[3] = ((String)currentRow.getAttribute("FstWkWed")).equals("Y") ? true : false;
        occurs[4] = ((String)currentRow.getAttribute("FstWkThu")).equals("Y") ? true : false;
        occurs[5] = ((String)currentRow.getAttribute("FstWkFri")).equals("Y") ? true : false;
        occurs[6] = ((String)currentRow.getAttribute("FstWkSat")).equals("Y") ? true : false;
        occurs[7] = ((String)currentRow.getAttribute("SndWkSun")).equals("Y") ? true : false;
        occurs[8] = ((String)currentRow.getAttribute("SndWkMon")).equals("Y") ? true : false;
        occurs[9] = ((String)currentRow.getAttribute("SndWkTue")).equals("Y") ? true : false;
        occurs[10] = ((String)currentRow.getAttribute("SndWkWed")).equals("Y") ? true : false;
        occurs[11] = ((String)currentRow.getAttribute("SndWkThu")).equals("Y") ? true : false;
        occurs[12] = ((String)currentRow.getAttribute("SndWkFri")).equals("Y") ? true : false;
        occurs[13] = ((String)currentRow.getAttribute("SndWkSat")).equals("Y") ? true : false;


        //set the start and end time
        String allday = (String)currentRow.getAttribute("Allday");
        Timestamp actEndTime = (Timestamp)currentRow.getAttribute("EndTime");
        Calendar endCalendar = Calendar.getInstance();
        endCalendar.setTimeInMillis(actEndTime.getTime());
        Timestamp actStartTime = (Timestamp)currentRow.getAttribute("StartTime");
        Calendar startCalendar = Calendar.getInstance();
        startCalendar.setTimeInMillis(actStartTime.getTime());
        // if allday then set the start time and end time
        if (allday != null && allday.equals("ALLDAY")) {
           // System.err.println(allday);
            if (actEndTime != null) {
                endCalendar.set(Calendar.HOUR_OF_DAY, 23);
                endCalendar.set(Calendar.MINUTE, 59);
                endCalendar.set(Calendar.SECOND, 59);
                currentRow.setAttribute("EndTime",new Timestamp(endCalendar.getTimeInMillis()));
            }
            if (actStartTime != null) {
                startCalendar.set(Calendar.HOUR_OF_DAY, 0);
                startCalendar.set(Calendar.MINUTE, 0);
                startCalendar.set(Calendar.SECOND, 0);
                currentRow.setAttribute("StartTime",new Timestamp(startCalendar.getTimeInMillis()));
            }
        }

        //what we need is only the time part
        int startHr = startCalendar.get(Calendar.HOUR_OF_DAY);
        int startMin = startCalendar.get(Calendar.MINUTE);
        int startSec = startCalendar.get(Calendar.SECOND);
        int endHr = endCalendar.get(Calendar.HOUR_OF_DAY);
        int endMin = endCalendar.get(Calendar.MINUTE);
        int endSec = endCalendar.get(Calendar.SECOND);

        //get other parts of reservation
        String batchNo = (String)currentRow.getAttribute("BatchNo");
        String title = (String)currentRow.getAttribute("Title");
        String userId = (String)currentRow.getAttribute("UserId");
        String userDisplayName = (String)currentRow.getAttribute("UserDisplayName");
        BigDecimal numOfPeople = (BigDecimal)currentRow.getAttribute("NumOfPeople");
        String classroom = (String)currentRow.getAttribute("MeetingRoom");
        String locationId = (String)currentRow.getAttribute("LocationId");
        String locationName = (String)currentRow.getAttribute("LocationName");
        String classroomId = (String)currentRow.getAttribute("MeetingRoomId");
        String allDay = (String)currentRow.getAttribute("Allday");
        String comments = (String)currentRow.getAttribute("Comments");
        String Participants = (String)currentRow.getAttribute("Participants");
        String NeedProjector = (String)currentRow.getAttribute("NeedProjector");
        String NeedLoudspeaker = (String)currentRow.getAttribute("NeedLoudspeaker");
        String NeedBeverage = (String)currentRow.getAttribute("NeedBeverage");
        String NeedFruits = (String)currentRow.getAttribute("NeedFruits");
        String NeedSnacks = (String)currentRow.getAttribute("NeedSnacks");
        String SnackLevel = (String)currentRow.getAttribute("SnackLevel");
        String ConfLevel = (String)currentRow.getAttribute("ConfLevel");        

        //get all days
        String recurType = (String)currentRow.getAttribute("RecurrenceType");
        int loopCap = recurType.equals("WEEKLY") ? 7 : 14;
        int offset = recurType.equals("WEEKLY") ? 0 : 7;

        //get start and end day
        Timestamp effDate = (Timestamp)currentRow.getAttribute("BatchEffectiveDate");
        Timestamp expireDate = (Timestamp)currentRow.getAttribute("BatchExpireDate");
        Calendar effStartCal = Calendar.getInstance();
        effStartCal.setTimeInMillis(effDate.getTime());
        Calendar expEndCal = Calendar.getInstance();
        expEndCal.setTimeInMillis(expireDate.getTime());

        //set new effective and expire date
        effStartCal.set(Calendar.DAY_OF_WEEK, 1);
        expEndCal.set(Calendar.DAY_OF_WEEK, 7);
        currentRow.setAttribute("BatchEffectiveDate", new Timestamp(effStartCal.getTime()));
        currentRow.setAttribute("BatchExpireDate", new Timestamp(expEndCal.getTime()));

        //get all occuring day
        int j = 0;
        ArrayList<Date> occurDays = new ArrayList<Date>();
        while (!(effStartCal.get(Calendar.DAY_OF_YEAR) == expEndCal.get(Calendar.DAY_OF_YEAR) &&
                 effStartCal.get(Calendar.YEAR) == expEndCal.get(Calendar.YEAR))) {

            int dayOfWeek = effStartCal.get(Calendar.DAY_OF_WEEK);
            if (j == loopCap)
                j = 0;
            if (j >= 7)
                dayOfWeek = dayOfWeek + offset;
            if (occurs[dayOfWeek - 1])
                occurDays.add(effStartCal.getTime());
            j++;
            effStartCal.add(Calendar.DAY_OF_YEAR, 1);
        }

        //create activities
        if (occurDays.size() > 0) {
            Calendar tempCal = Calendar.getInstance();
            ConfRmConflictViewImpl calendarConflitQueryImpl = this.getConfRmConflict();
            ConfRoomCalendarViewImpl calDMLViewImpl = this.getConfRoomCalendarView();

            for (Date date : occurDays) {
                Row newActivity = calDMLViewImpl.createRow();
                newActivity.setAttribute("BatchNo", batchNo);
                newActivity.setAttribute("Title", title);
                newActivity.setAttribute("UserId", userId);
                newActivity.setAttribute("UserDisplayName", userDisplayName);
                newActivity.setAttribute("NumOfPeople", numOfPeople);
                newActivity.setAttribute("MeetingRoom", classroom);
                newActivity.setAttribute("LocationId", locationId);
                newActivity.setAttribute("LocationName", locationName);
                newActivity.setAttribute("MeetingRoomId", classroomId);
                newActivity.setAttribute("Allday", allDay);
                newActivity.setAttribute("Comments", comments);
                newActivity.setAttribute("Participants", Participants);
                newActivity.setAttribute("NeedProjector", NeedProjector);
                newActivity.setAttribute("NeedLoudspeaker", NeedLoudspeaker);
                newActivity.setAttribute("NeedBeverage", NeedBeverage);
                newActivity.setAttribute("NeedFruits", NeedFruits);
                newActivity.setAttribute("NeedSnacks", NeedSnacks);
                newActivity.setAttribute("SnackLevel", SnackLevel);
                newActivity.setAttribute("ConfLevel", ConfLevel);
                newActivity.setAttribute("State", Constants.STATE_REVIEWED);
                
                tempCal.setTime(date);
                tempCal.set(Calendar.HOUR_OF_DAY, startHr);
                tempCal.set(Calendar.MINUTE, startMin);
                tempCal.set(Calendar.SECOND, startSec);
                newActivity.setAttribute("StartTime", new Timestamp(tempCal.getTimeInMillis()));
                java.sql.Timestamp start = new java.sql.Timestamp(tempCal.getTimeInMillis());
                tempCal.set(Calendar.HOUR_OF_DAY, endHr);
                tempCal.set(Calendar.MINUTE, endMin);
                tempCal.set(Calendar.SECOND, endSec);
                newActivity.setAttribute("EndTime", new Timestamp(tempCal.getTimeInMillis()));
                java.sql.Timestamp end = new java.sql.Timestamp(tempCal.getTimeInMillis());
                calDMLViewImpl.insertRow(newActivity);
                if (!hasconflict) {
                    hasconflict = !calendarConflitQueryImpl.ifConflict(start, end, classroomId, "-1",batchNo);
                }
            }
        }

        this.getDBTransaction().commit();

        return hasconflict;
    }

    public void deleteCurrentBatchOrder() {
        
        ConfRoomBatchReservationViewImpl btchRsvtnView = this.getConfRoomBatch();
        /* Validate Current Batch Input */
        Row currentRow = btchRsvtnView.getCurrentRow();
        if (currentRow != null) {
            /* Remove all classroom activity associated with this batch  */
            deleteRelatedClassroomActivities(currentRow);
            currentRow.remove();
            this.getDBTransaction().commit();
        }
    }

    /**
     * 删除和批量预订相关联的所有预订
     * @param currentRow
     */
    private void deleteRelatedClassroomActivities(Row currentRow) {
        ConfRoomCalendarViewImpl calDMLViewImpl = this.getConfRoomCalendarView();
        calDMLViewImpl.setApplyViewCriteriaNames(null);
        ViewCriteria criteria = calDMLViewImpl.getViewCriteria("findByBatchNo");
        calDMLViewImpl.applyViewCriteria(criteria);
        calDMLViewImpl.setRangeSize(-1);
        calDMLViewImpl.setbatchNo((String)currentRow.getAttribute("BatchNo"));
        calDMLViewImpl.executeQuery();
        Row[] allRowsInRange = calDMLViewImpl.getAllRowsInRange();
        if (allRowsInRange != null && allRowsInRange.length > 0) {
            for (Row row : allRowsInRange) {
                row.remove();
            }
        }
    }

    /**
     * Container's getter for ConfRoomCalendarView.
     * @return ConfRoomCalendarView
     */
    public ConfRoomCalendarViewImpl getConfRoomCalendarView() {
        return (ConfRoomCalendarViewImpl)findViewObject("ConfRoomCalendarView");
    }

    /**
     * Container's getter for Locations.
     * @return Locations
     */
    public ViewObjectImpl getLocations() {
        return (ViewObjectImpl)findViewObject("Locations");
    }

    /**
     * Container's getter for ConfRmOfLocation.
     * @return ConfRmOfLocation
     */
    public LovsViewImpl getConfRmOfLocation() {
        return (LovsViewImpl)findViewObject("ConfRmOfLocation");
    }

    /**
     * Container's getter for ConfRoomQuery.
     * @return ConfRoomQuery
     */
    public ConfRoomQueryViewImpl getConfRoomQuery() {
        return (ConfRoomQueryViewImpl)findViewObject("ConfRoomQuery");
    }

    /**
     * Container's getter for ConfRmConflict.
     * @return ConfRmConflict
     */
    public ConfRmConflictViewImpl getConfRmConflict() {
        return (ConfRmConflictViewImpl)findViewObject("ConfRmConflict");
    }

    /**
     * Container's getter for ConfRoomBatch.
     * @return ConfRoomBatch
     */
    public ConfRoomBatchReservationViewImpl getConfRoomBatch() {
        return (ConfRoomBatchReservationViewImpl)findViewObject("ConfRoomBatch");
    }

    /**
     * Container's getter for LocConfRmLink1.
     * @return LocConfRmLink1
     */
    public ViewLinkImpl getLocConfRmLink1() {
        return (ViewLinkImpl)findViewLink("LocConfRmLink1");
    }
}
